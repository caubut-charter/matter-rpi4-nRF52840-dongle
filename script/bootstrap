#!/bin/bash

set -euETo pipefail
shopt -s inherit_errexit

cd "$(dirname "$0")/.."

usage () {
  echo -e 'Usage: bootstrap [OPTIONS] [[TARGET [COMMIT|BRANCH|TAG]] ...]\n'
  echo -e 'Examples:'
  echo -e '  bootstrap --all                     # Bootstrap everything.'
  echo -e '  bootstrap --chip                    # Bootstrap latest Matter source.'
  echo -e '  bootstrap --chip test_event_6       # Bootstrap latest Matter source.'
  echo -e '                                      # Checkout the '\''test_event_6'\'''
  echo -e '                                      # Matter branch.'
  echo -e '  bootstrap --chip test_event_6 --all # Bootstrap everything.'
  echo -e '                                      # Checkout the '\''test_event_6'\'''
  echo -e '                                      # Matter branch.\n'
  echo -e ' Targets:'
  echo -e ' \t--otbr               \t OpenThread Border Router'
  echo -e ' \t--ot-nrf528xx        \t nRF528xx OpenThread RCP firmware'
  echo -e ' \t--ot-commissioner    \t OpenThread Commissioner'
  echo -e ' \t--chip               \t Matter (Connected Home IP a.k.a CHIP)'
  echo -e ' \t--nrfconnect-chip    \t nRF Connect / Matter build environment'
  echo -e ' \t-a, --all            \t all targets\n'
  echo -e ' Options:'
  echo -e ' \t-f, --fix-permissions\t fix permission errors'
  echo -e ' \t-h, --help           \t print this help list'
}

FIX_PERMISSIONS=false

OTBR=false
OT_NRF528XX=false
OT_COMMISSIONER=false
CONNECTEDHOMEIP=false
NRFCONNECT_CHIP=false

declare -A repos
repos=()

# shellcheck disable=SC2120
otbr() {
  OTBR=true
  checkout=${1:-main}
  repos['https://github.com/openthread/ot-br-posix.git']="$checkout"
}

# shellcheck disable=SC2120
ot_nrf528xx() {
  OT_NRF528XX=true
  checkout=${1:-main}
  repos['https://github.com/openthread/ot-nrf528xx.git']="$checkout"
}

# shellcheck disable=SC2120
ot_commissioner() {
  OT_COMMISSIONER=true
  checkout=${1:-main}
  repos['https://github.com/openthread/ot-commissioner.git']="$checkout"
}

# shellcheck disable=SC2120
connectedhomeip() {
  CONNECTEDHOMEIP=true
  checkout=${1:-master}
  repos['https://github.com/project-chip/connectedhomeip.git']="$checkout"
}

# shellcheck disable=SC2120
nrfconnect_chip() {
  NRFCONNECT_CHIP=true
  checkout=${1:-master}
  repos['https://github.com/NordicPlayground/nrfconnect-chip-docker.git']="$checkout"
}

all() {
  # shellcheck disable=SC2119
  [ "$OTBR" = true ] || otbr
  # shellcheck disable=SC2119
  [ "$OT_NRF528XX" = true ] || ot_nrf528xx
  # shellcheck disable=SC2119
  [ "$OT_COMMISSIONER" = true ] || ot_commissioner
  # shellcheck disable=SC2119
  [ "$CONNECTEDHOMEIP" = true ] || connectedhomeip
  # shellcheck disable=SC2119
  [ "$NRFCONNECT_CHIP" = true ] || nrfconnect_chip
}

args=("$@")

process_source() {
  if [ ${#args[@]} -gt 1 ]; then
    case ${args[1]} in
      -*) $1 ;;
      *)
        $1 "${args[1]}"
        args=("${args[@]:1}");
        ;;
    esac
  else
    $1
  fi
}

while [ ${#args[@]} -gt 0 ]; do
  case ${args[0]} in
    --ot-br-posix) process_source ot_br_posix ;;
    --ot-nrf528xx) process_source ot_nrf528xx ;;
    --ot-commissioner) process_source ot_commissioner ;;
    --chip) process_source connectedhomeip ;;
    --nrfconnect-chip) process_source nrfconnect_chip ;;
    -a | --all) all ;;
    -f | --fix-permissions) FIX_PERMISSIONS=true ;;
    -h | --help) usage; exit;;
    *) usage; exit 1 ;;
  esac
  args=("${args[@]:1}");
done

if [ "$FIX_PERMISSIONS" = true ]; then
  echo "==> Fixing permissions (may take a couple minutes)..."
  docker run --rm \
    -v "$PWD":/root \
    -w /root \
    ubuntu:21.04 /bin/bash -c "chown -R $(id -u):$(id -g) ."
fi

mkdir -p third_party

for repo in "${!repos[@]}"; do
  (
    cd third_party
    (
      dir=$(tmp=${repo##*/};echo "${tmp%.*}")
      if [[ ! -d $dir ]]; then (set -x && mkdir -p "$dir"); fi
      cd "$dir"
      if [[ $(git rev-parse --git-dir 2> /dev/null) != '.git' ]]; then
        echo "==> Cloning '$repo'..."
        (set -x && git clone -j8 "$repo" .)
      else
        echo "==> Updating '$repo'..."
        (
          set -x \
          && git fetch \
          && git reset --hard && git clean -fd \
          && git submodule foreach --recursive git reset --hard \
          && git submodule foreach --recursive git clean -fd
        )
      fi
      echo "==> Checking out '${repos[$repo]}'..."
      (
        set -x \
        && git checkout -B "${repos[$repo]}" "origin/${repos[$repo]}" \
        && git submodule update --init --recursive
      )
    )
  )
done

if [[ "$OTBR" = true ]]; then
  (set -x && cd third_party/ot-br-posix && ./script/bootstrap)
fi
