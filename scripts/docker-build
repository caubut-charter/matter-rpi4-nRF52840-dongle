#!/usr/bin/env -S bash -euET -o pipefail -O inherit_errexit

ARCH=$(uname -m)

[[ -z ${TERM} ]] && TPUTTERM=' -T xterm-256color' || TPUTTERM=''
BOLD=`tput${TPUTTERM} bold`
RED=`tput${TPUTTERM} setaf 1`
RESET=`tput${TPUTTERM} sgr0`

if [[ $ARCH != "x86_64" && $ARCH != "aarch64" ]]; then
  echo "Unsupported architecture: $ARCH"
  exit 1;
fi

AVAHI_UTILS=false
MATTER_ENVIRONMENT=false
OPENTHREAD_ENVIRONMENT=false
OT_COMMISSIONER=false
OTBR=false
NRFCONNECT_CHIP=false
NRFUTIL=false

ORG=${ORG:-}
if [[ ! -z $ORG ]]; then ORG="$ORG/"; fi
DOCKER_BUILD=${DOCKER_BUILD:-docker build}
VERSION=${VERSION:-latest}

while [ $# -gt 0 ] ; do
  case $1 in
    --avahi-utils) AVAHI_UTILS=true ;;
    --matter-environment) MATTER_ENVIRONMENT=true ;;
    --openthread-environment) OPENTHREAD_ENVIRONMENT=true ;;
    --ot-commissioner) OT_COMMISSIONER=true; OPENTHREAD_ENVIRONMENT=true ;;
    --otbr) OTBR=true ;;
    --nrfconnect-chip) NRFCONNECT_CHIP=true ;;
    --nrfutil) NRFUTIL=true ;;
    --all) AVAHI_UTILS=true; MATTER_ENVIRONMENT=true; OPENTHREAD_ENVIRONMENT=true; OT_COMMISSIONER=true; OTBR=true; NRFCONNECT_CHIP=true; NRFUTIL=true ;;
  esac
  shift
done

declare -A HASHES=(
	['third_party/connectedhomeip/third_party/openthread/repo/etc/docker/environment/Dockerfile']="14ca28d53cfbbf8c99d33fd31d3c7511"
	['third_party/nrfconnect-chip-docker/nrfconnect-toolchain/Dockerfile']="0dceb02b0e528798bc54209547baefb5"
	['third_party/nrfconnect-chip-docker/nrfconnect-chip/Dockerfile']="4878612ae4cebb9d69deabe46cc234d9"
)

declare -A HASH_CHECKS=(
  ['third_party/connectedhomeip/third_party/openthread/repo/etc/docker/environment/Dockerfile']=$OPENTHREAD_ENVIRONMENT
	['third_party/nrfconnect-chip-docker/nrfconnect-toolchain/Dockerfile']=$NRFCONNECT_CHIP
	['third_party/nrfconnect-chip-docker/nrfconnect-chip/Dockerfile']=$NRFCONNECT_CHIP
)

check_hash () {
  MD5=($(md5sum $1))
  if [[ -v "HASHES[$1]" && -v "HASH_CHECKS[$1]" && ${HASH_CHECKS[$1]} && $MD5 != ${HASHES[$1]} ]]; then
    echo -e "${BOLD}${RED}HASH_ERROR: $1\n"
    echo "Unable to patch file, hash mismatch."
    echo -e "Manually validate the patch and update the hash to proceed.\n"
    echo "COMPUTED: $MD5"
    echo "EXPECTED: ${HASHES[$1]}${RESET}"
    exit 1;
  fi
}

(
  cd "$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
  cd ..

  if [[ $AVAHI_UTILS = true ]]; then
    (set -x && $DOCKER_BUILD -t ${ORG}avahi-utils:$VERSION etc/docker/avahi/avahi-utils)
  fi

  if [[ $OPENTHREAD_ENVIRONMENT = true || $OT_COMMISSIONER = true ]]; then
    (cd third_party/connectedhomeip/third_party/openthread/repo && git reset --hard)
    check_hash "third_party/connectedhomeip/third_party/openthread/repo/etc/docker/environment/Dockerfile"

    if [[ $ARCH = "aarch64" ]]; then
      sed -i \
        -e '21,$d' \
        -e '/python3 -m pip install -U cmake/i \    && python3 -m pip install --upgrade pip \\' \
        third_party/connectedhomeip/third_party/openthread/repo/etc/docker/environment/Dockerfile
    fi;
    (cd third_party/connectedhomeip/third_party/openthread/repo \
      && set -x && $DOCKER_BUILD -t ${ORG}openthread-environment:$VERSION -f etc/docker/environment/Dockerfile .)
  fi

  if [[ $OT_COMMISSIONER = true ]]; then
    (set -x && $DOCKER_BUILD --build-arg "BASE=${ORG}openthread-environment:$VERSION" \
     -t ${ORG}ot-commissioner:$VERSION etc/docker/openthread/ot-commissioner)
  fi

  if [[ $OTBR = true ]]; then
    (cd third_party/ot-br-posix \
       && set -x && $DOCKER_BUILD --build-arg INFRA_IF_NAME=eth1 -t ${ORG}otbr:$VERSION -f etc/docker/Dockerfile .)
  fi

  if [[ $MATTER_ENVIRONMENT = true ]]; then
    (set -x && $DOCKER_BUILD -t ${ORG}matter-environment:$VERSION etc/docker/matter/environment)
  fi

  if [[ $NRFCONNECT_CHIP = true ]]; then
    (cd third_party/nrfconnect-chip-docker && git reset --hard)
    check_hash "third_party/nrfconnect-chip-docker/nrfconnect-toolchain/Dockerfile"
    check_hash "third_party/nrfconnect-chip-docker/nrfconnect-chip/Dockerfile"

    sed -i \
      -e '44,52d' \
      -e "s/x86_64/${ARCH}/" \
      -e '/NRF_TOOLS_URL/d' \
      -e 's/gcc-arm-none-eabi-9-2019-q4-major/gcc-arm-none-eabi-9-2020-q2-update/' \
      third_party/nrfconnect-chip-docker/nrfconnect-toolchain/Dockerfile
    if [[ $ARCH = "aarch64" ]]; then
      sed -i \
        -e 's/\(libpython3-dev\) \\/\1 make \\/' \
        third_party/nrfconnect-chip-docker/nrfconnect-toolchain/Dockerfile
    fi;
    (cd third_party/nrfconnect-chip-docker/nrfconnect-toolchain \
     && set -x && $DOCKER_BUILD \
      --build-arg TOOLCHAIN_URL=https://developer.arm.com/-/media/Files/downloads/gnu-rm/9-2020q2/gcc-arm-none-eabi-9-2020-q2-update-${ARCH}-linux.tar.bz2 \
      -t ${ORG}nrfconnect-toolchain:$VERSION .)

    if [[ $ARCH = "aarch64" ]]; then
      sed -i \
        -e 's/amd64/arm64/' \
        -e 's/g++-multilib //' \
        third_party/nrfconnect-chip-docker/nrfconnect-chip/Dockerfile
    fi;
    (cd third_party/nrfconnect-chip-docker/nrfconnect-chip \
     && set -x && $DOCKER_BUILD \
      --build-arg "BASE=${ORG}nrfconnect-toolchain:$VERSION" -t ${ORG}nrfconnect-chip:$VERSION .)
  fi

  if [[ $NRFUTIL = true ]]; then
    (set -x && $DOCKER_BUILD -t ${ORG}nrfutil:$VERSION etc/docker/nordicsemi/nrfutil)
  fi
)
